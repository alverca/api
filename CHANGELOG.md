# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](http://keepachangelog.com/).

## Unreleased

### Added

- パフォーマンスの拡張属性更新値に返金済数と未返金数を追加

### Changed

### Deprecated

### Removed

### Fixed

### Security

## v35.2.0 - 2020-06-03

### Changed

- イベントの注文返品をまとめて実行するように調整

## v35.1.0 - 2020-06-01

### Added

- Eメール送信タスクを追加

## v35.0.0 - 2020-05-28

### Changed

- イベントインポート処理をイベント変更時処理へ移行
- Chevre予約取消をCinerinoで処理するように変更
- 不要なイベント集計データ削除を集計処理後に実行するように調整
- 入場ゲートリポジトリをプロセス起動時に初期化するように変更
- イベントに対する注文返品処理時の不要なパラメータ指定を削除

## v34.1.0 - 2020-05-26

### Added

- イベント変更イベント受信エンドポイントを追加
- Cinerinoイベントインポートタスクを追加

### Changed

- イベントインポート時の検索先をCinerinoへ変更
- 予約の発券&入場処理をCinerinoへ移行
- 予約集計処理をCinerino使用へ変更

## v34.0.0 - 2020-05-22

### Removed

- Chevreイベント作成タスクを削除

## v33.9.0 - 2020-05-20

### Changed

- Chevreイベントのカタログ情報をhasOfferCatalogへ移行

## v33.8.0 - 2020-05-14

### Added

- ChevreイベントにhasOfferCatalogを追加

## v33.7.0 - 2020-05-12

### Changed

- プロジェクトリポジトリを@cinerino/domainから移行
- タスクリポジトリを@cinerino/domainから移行

## v33.6.0 - 2020-04-07

### Changed

- Cinerinoサービス使用時にプロジェクトを指定するように調整
- イベント作成時に販売者情報を追加するように調整

## v33.5.0 - 2020-03-14

### Changed

- update @chevre/api-nodejs-client

## v33.4.0 - 2020-03-12

### Changed

- オファーカタログ設定を料金改定版に変更
- 予約参照時にchevreへチェックイン連携するように調整

## v33.3.0 - 2020-03-11

### Added

- 注文番号での予約検索エンドポイントを追加

## v33.2.0 - 2020-03-10

### Changed

- イベント情報に取り込むオファーコードを限定するように設定追加
- update @chevre/api-nodejs-client

## v33.1.0 - 2020-03-07

### Changed

- update @chevre/api-nodejs-client

## v33.0.1 - 2020-02-20

### Fixed

- Array型の座席タイプに対応

## v33.0.0 - 2020-02-18

### Changed

- 車椅子レート制限をChevreへ移行
- 注文取引中の不要なセッション管理を削除

### Removed

- 購入番号リポジトリを削除

## v32.9.0 - 2020-02-14

### Changed

- 独自購入番号発行を削除
- 注文取引確定後のアクションカスタムを削除
- 注文識別子カスタムを削除
- 新しい予約承認取消サービスを使用するように調整

## v32.8.0 - 2020-02-12

### Changed

- 注文確定後の余分確保分予約へのextraプロパティ連携を削除

## v32.7.1 - 2020-02-04

### Changed

- String型のseatingTypeに対応

## v32.7.0 - 2020-02-03

### Changed

- String型のseatingTypeに対応

## v32.6.0 - 2020-01-07

### Changed

- イベントに対する全注文返品処理において、該当注文の検索を注文取引検索から注文検索へ変更
- update @cinerino/factory

## v32.5.0 - 2019-12-23

### Changed

- transactionsスコープでパフォーマンス検索を実行できるように調整
- transactionsスコープでIDでの予約検索を実行できるように調整

## v32.4.0 - 2019-12-04

### Changed

- 券種カテゴリーレート制限を実装

## v32.3.0 - 2019-12-03

### Changed

- 券種カテゴリーレート制限解除を実装
- 予約ステータス変更時処理において、進行中の取引については券種カテゴリーレート制限を解除しないように調整

## v32.2.0 - 2019-12-02

### Added

- 券種カテゴリーレート制限ルーターを追加

## v32.1.0 - 2019-11-22

### Removed

- Chevre予約に対する旧東京タワー予約の互換性維持対応を削除

## v32.0.0 - 2019-11-21

### Removed

- 旧注文イベント受信エンドポイントを削除
- 旧予約確定イベント受信エンドポイントを削除
- 旧予約取消イベント受信エンドポイントを削除

## v31.4.0 - 2019-11-20

### Added

- 注文ステータス変更イベント受信エンドポイント追加

### Changed

- 注文返品レポート作成処理と返品手数料レポート作成処理を分離
- 注文通知設定をCinerinoプロジェクト設定で移行

## v31.3.0 - 2019-11-18

### Changed

- イベント予約集計時に、車椅子残席数が受けるイベントに関しても同時に集計するように調整

## v31.2.0 - 2019-11-13

### Changed

- 購入番号をフロントで発行するように調整

## v31.1.0 - 2019-11-13

### Added

- 購入番号発行サービスを追加
- 購入番号を注文識別子から取得するように調整

## v31.0.0 - 2019-11-12

### Removed

- 印刷トークン発行サービスを削除

## v30.5.0 - 2019-11-08

### Changed

- 注文取引確定サービスをCinerino本家へ変更

## v30.4.0 - 2019-11-07

### Changed

- 注文取引確定時の予約連携指定をCinerino化

## v30.3.0 - 2019-11-07

### Changed

- 注文取引確定時の注文通知先指定をCinerino化

## v30.2.0 - 2019-11-06

### Changed

- POSによる注文返品取引をCinerinoで再構築

## v30.1.0 - 2019-11-02

### Changed

- 注文返品取引から予約通知URLの指定を削除

## v30.0.0 - 2019-11-01

### Changed

- 予約確定イベントと予約取消イベントの受信エンドポイントを予約ステータス変更イベントに統合

## v29.0.0 - 2019-10-31

### Changed

- POS注文取引確定時の決済方法指定を削除
- 注文取引開始時の販売者をIDで指定するように調整
- @cinerino/api-nodejs-client@2.0.0-alpha.35で再構築
- POS使用サービスにposスコープを許可

## v28.1.1 - 2019-10-29

### Changed

- 予約ステータス変更時イベントを最適化

## v28.1.0 - 2019-10-28

### Changed

- 予約ステータス変更時イベントを最適化

## v28.0.0 - 2019-10-25

### Changed

- イベントに対する全注文返品処理からアクションリポジトリを削除
- 取引失効時処理を予約取消時処理へ変更
- POS進行中注文取引金額を保管するように調整

## v27.0.0 - 2019-10-24

### Changed

- POS注文取引をCinerino SDKで再構築
- POS注文返品取引をCinerino SDKで再構築
- 返品レポート作成時の手数料を注文データから取得するように調整
- 注文返品時のイベント情報連携処理から注文リポジトリと取引リポジトリを削除
- イベントに対する全注文返品処理をCinerino SDKで再構築

## v26.0.0 - 2019-10-21

### Changed

- 代理予約による注文判定をcustomer識別子で行うように調整(代理予約クライアントIDへの依存排除)

### Removed

- POSによる取引に不要な機能を削除

## v25.0.0 - 2019-10-18

### Removed

- 注文ルーターを削除(Cinerino移行)
- IAMルーターを削除
- プロジェクトルーターを削除
- 販売者ルーターを削除
- ユーザープールルーターを削除
- イベントルーターを削除
- 組織ルーターを削除
- 取引に関する非同期タスクを削除(Cinerino移行)

## v24.0.0 - 2019-10-15

### Added

- 取引ウェブフック設定を追加
- 取引ステータス変更イベント受信エンドポイントを追加

### Changed

- イベントの注文返金数連携を、返金後のウェブフックで対応するように調整
- 取引失効時の在庫調整を、失効時ウェブフックで対応するように調整

### Removed

- クレジットカード返金取引結果の注文返品取引へのデータ連携を削除

## v23.0.0 - 2019-10-11

### Added

- 注文返品後の予約取消タスクを追加
- 注文返品後のクレジットカード返金タスクを追加

### Changed

- 座席予約承認結果からtmpReservationsを削除
- 注文返品処理時に、クレジットカード返金状態に関わらず注文ステータス変更と予約取消が実行されるように調整
- 販売者都合での注文返品時、注文返品取引確定時に返金後メールを指定するように調整
- 注文返品タスクをCinerino化
- 注文返品取引インターフェースをCinerino化
- 注文返品取引サービスをCinerino化

## v22.2.1 - 2019-10-04

### Changed

- update @tokyotower/domain

## v22.2.0 - 2019-10-03

### Added

- 座席予約承認結果にacceptedOffersを追加

### Changed

- 座席予約承認結果をCinerino化
- 注文取引結果生成処理をCinerino化

## v22.1.1 - 2019-09-30

### Changed

- 注文データのacceptedOffersを最適化

## v22.1.0 - 2019-09-27

### Changed

- 注文データのacceptedOffersを最適化
- 注文レポートから不要な情報(実務上使用されていない情報)を削除

## v22.0.0 - 2019-09-26

### Changed

- 注文データから確定予約情報を削除
- 決済方法タイプをCinerino化

## v21.10.0 - 2019-09-24

### Changed

- 取引リポジトリをCinerino化
- Chevre@6.0.0に対応
- 注文取引サービスを@cinerino/domainへ移行
- 座席予約承認時のイベント存在確認を直接Chevreにて実行するように変更
- 会員リポジトリをCinerino化

## v21.8.0 - 2019-09-18

### Changed

- Chevre@6.0.0に対応

## v21.7.0 - 2019-09-17

### Changed

- 全リソースにプロジェクト属性を結合

## v21.6.0 - 2019-09-05

### Changed

- 予約確定時の予約者属性とポストアクションをカスタムできるように調整
- SettleSeatReservationタスクを廃止
- 注文番号をCinerino化
- Eメール送信タスクをCinerino化
- 通知サービスをCinerino化

## v21.5.0 - 2019-09-02

### Changed

- 注文返品レポート作成タスクを、注文返品後の通知アクション先で作成するように設計変更

## v21.4.0 - 2019-08-30

### Changed

- 注文レポート作成タスクを、注文後の通知アクション先で作成するように設計変更
- 注文取引の決済方法に関するバリデーションをAPIアプリケーション側へ以降

## v21.3.0 - 2019-08-28

### Added

- 注文後の配送タスクと予約確定タスクを追加

### Changed

- 予約データの決済方法には、注文データの決済方法名を連携するように変更
- 注文インターフェースをCinerino化
- 注文取引インターフェースをCinerino化

## v21.2.0 - 2019-08-22

### Changed

- 人物インターフェースをCinerino化
- アクションインターフェースをCinerino化
- 取引インターフェースをCinerino化

## v21.1.0 - 2019-08-19

### Changed

- POSと内部予約に対しても注文取引における承認価格バリデーションを追加
- 座席予約承認のイベント属性を最適化

### Deprecated

### Removed

- 注文取引から顧客連絡先属性を削除

## v21.0.0 - 2019-08-15

### Changed

- クレジットカード以外の決済方法に対する承認アクションに対応

### Removed

- 注文取引から購入者区分属性を削除
- SettleCreditCardタスクを削除

## v20.0.0 - 2019-08-14

### Changed

- クレジットカード決済タスクをCinerino化

### Removed

- CreateOrderタスクを削除

## v19.0.0 - 2019-08-13

### Changed

- 座席予約承認アクションインターフェースをCinerino化

## v18.8.0 - 2019-08-12

### Changed

- 注文作成タスクをCinerino化
- update @tokyotower/domain

## v18.7.0 - 2019-08-09

### Changed

- リポジトリのCinerino継承
- 決済サービス、ユーティリティサービスをCinerino継承

## v18.6.1 - 2019-08-08

### Changed

- update @tokyotower/domain

## v18.6.0 - 2019-08-07

### Changed

- クレジットカード決済サービスをCinerino化

## v18.5.1 - 2019-08-06

### Changed

- update @tokyotower/domain
- 不要な依存パッケージを削除

## v18.5.0 - 2019-08-05

### Changed

- クレジットカード決済承認アクションインターフェースをCinerino化
- 座席予約承認アクションインターフェースをCinerino化

## v18.4.1 - 2019-08-02

### Changed

- 入場時に万が一Chevreに予約が存在しなくても正常終了するように調整

## v18.4.0 - 2019-08-01

### Changed

- アクション、タスク、取引、注文にプロジェクト属性を追加

## v18.3.0 - 2019-07-31

### Changed

- 注文インターフェースをCinerino化

## v18.2.0 - 2019-07-30

### Changed

- 座席予約承認アクションの仮予約データに、余分座席分が含まれないように調整
- 注文へのクレジットカード決済情報連携強化

## v18.1.0 - 2019-07-29

### Added

- 売上集計ストリーミング検索を追加

### Changed

- 入場アクションをCheverへ連携
- 中止タスクが存在しない場合に例外が投げられないように調整
- 車椅子予約を含む注文データに、余分座席分が含まれないように調整

## v18.0.0 - 2019-07-26

### Changed

- 座席の在庫管理をChevreへ移行

### Removed

- 在庫リポジトリを削除

## v17.0.1 - 2019-07-24

### Changed

- GMOサイト設定をプロジェクトリポジトリから参照するように変更

## v17.0.0 - 2019-07-23

### Changed

- 券種IDと券種コードを分離
- 予約IDを購入番号と完全分離
- Chevreエンドポイント設定をプロジェクトリポジトリを参照するように変更

### Removed

- 座席予約オファーインターフェースから冗長な属性を削除

## v16.0.0 - 2019-07-22

### Added

- 定期タスクをjobsアプリケーションから移行

## v15.0.0 - 2019-07-19

### Added

- 非同期の継続的タスクをjobsアプリケーションから移行

## v14.0.0 - 2019-07-18

### Added

- 予約検索条件の予約者に$elemMatchを追加

### Changed

- 予約データに購入番号を追加
- 予約番号と購入番号を分離

### Removed

- 注文照会キーを削除

## v13.1.1 - 2019-07-15

### Changed

- 注文コレクションのインデックス調整

## v13.1.0 - 2019-07-15

### Changed

- 注文確認番号を上映日と予約番号の組み合わせに変更

## v13.0.0 - 2019-07-12

### Added

- イベントのオファー検索エンドポイントを追加

### Changed

- Chevreからの作品コードの引き継ぎを調整
- パフォーマンス検索レスポンスから券種リストを削除
- 複数座席の仮押さえを一度に実行するように変更

### Removed

- パフォーマンスインターフェースから券種情報を削除
- 仮予約インターフェースから冗長な属性を削除

## v12.1.0 - 2019-07-05

### Added

- パフォーマンス検索条件にIDを追加

## v12.0.0 - 2019-07-05

### Changed

- パフォーマンス検索条件をChevre化

## v11.0.0 - 2019-07-03

### Changed

- パフォーマンスを開始日時で検索時にstartDateを参照するように調整

### Removed

- 注文取引結果からeventReservationsを削除(order.acceptedOffersへ移行)
- 仮予約インターフェースから座席グレードを削除
- 仮予約インターフェースからrate_limit_unit_in_secondsを削除
- パフォーマンスインターフェースから非推奨属性を削除

## v10.0.1 - 2019-07-01

### Changed

- 予約変更時に更新日時を連携

## v10.0.0 - 2019-07-01

### Changed

- 予約の入場以外の全属性をChevre化
- 券種インターフェースをChevre化

## v9.0.0 - 2019-06-27

### Removed

- 予約インターフェースから不要な属性を削除
- 予約コレクションからqr_strに対するユニークインデックスを削除

## v8.1.0 - 2019-06-25

### Changed

- 予約検索条件に更新日時を追加

## v8.0.0 - 2019-06-25

### Removed

- 券種からキャンセルチャージ属性を削除
- 予約インターフェースから不要な属性を削除
- 予約検索条件インターフェースから不要な属性を削除

## v7.1.1 - 2019-06-23

### Changed

- 予約検索条件にイベント終了日時を追加

## v7.1.0 - 2019-06-23

### Changed

- 予約検索条件にイベント終了日時を追加

## v7.0.0 - 2019-06-22

### Changed

- 予約データをChevreインターフェースへ変換する処理を追加

## v6.2.0 - 2019-06-18

### Changed

- パフォーマンスインターフェースを拡張

## v6.1.0 - 2019-06-14

### Changed

- 予約検索条件を拡張
- 車椅子の余分確保分を予約として作成するように調整

### Removed

- 在庫インターフェースを削除

## v6.0.2 - 2019-06-12

### Changed

- 券種のchargeをpriceSpecificationに置換

## v6.0.1 - 2019-06-11

### Changed

- 券種のchargeをpriceSpecificationに置換

## v6.0.0 - 2019-06-10

### Added

- 予約distinct検索追加
- 予約キャンセル追加
- パフォーマンス拡張属性更新を追加
- イベント予約集計タスクを追加

### Changed

- パフォーマンス検索条件から作品関係を削除
- パフォーマンスコレクションからリレーションを削除
- 予約リポジトリのmongooseモデルをprivate化
- パフォーマンスリポジトリのmongooseモデルをprivate化
- 新しいRedis在庫リポジトリで再構築
- 予約検索条件調整
- パフォーマンスインターフェースをChevre化に向けて補強
- 新しい一時イベントリポジトリで再構築
- スクリーンに車椅子タイプ座席をひとつ持つように設計調整

### Removed

- 劇場、スクリーン、作品、券種、券種グループコレクションを削除(一時的に動的データ管理を不可能に変更)
- GMO通知コレクションを削除
- SendGridイベントコレクションを削除
- パフォーマンスデータから不要な項目を削除
- 一時イベントオファーリポジトリを削除

## v5.9.0 - 2019-05-26

### Added

- プロジェクトルーターを追加

## v5.8.0 - 2019-04-19

### Added

- WAITER無効化フラグを追加
- IAMルーターを追加

### Changed

- 取引コレクションのインデックス調整
- 予約インターフェースをChevreを継承するように拡張
- 組織コレクションのインデックス調整
- 注文取引の購入者プロフィール情報の持ち方をCinerinoに統一
- install mongoose@5.5.1
- install @motionpicture/ttts-domain@13.5.0

## v5.7.1 - 2019-04-15

### Changed

- イベント検索を最低限の検索条件対応で実装

## v5.7.0 - 2019-04-15

### Added

- ヘルスルーターを追加
- 統計ルーターを追加
- イベントルーターを追加

## v5.6.0 - 2019-03-29

### Added

- 販売者ルーターを追加

## v5.5.1 - 2018-12-26

### Fixed

- アプリケーションによるWAITER必須設定を再追加

## v5.5.0 - 2018-12-23

### Added

- 注文検索を追加
- タスク検索を追加
- 取引検索を追加

## v5.4.8 - 2018-12-11

### Fixed

- moment-timezoneを適切にrequireできていないコードを修正

## v5.4.7 - 2018-12-10

### Changed

- 複数のWAITER許可証発行者に対応

## v5.4.6 - 2018-11-28

### Changed

- 入場イベントを注文レポートへ連動

## v5.4.5 - 2018-06-25

### Fixed

- 返品処理のクエリを調整

## v5.4.4 - 2018-03-22

### Added

- 決済方法に手売りを追加。

## v5.4.3 - 2018-02-14
### Changed
- 予約スキーマに注文取引主体属性を追加。

### Fixed
- 注文取引確定時の注文番号重複エラーをAlreadyInUseエラーとしてハンドリング。

## v5.4.2 - 2018-02-02
### Fixed
- 購入者情報として日本以外の国の電話番号が登録できないバグを修正。
- 同じ上演日で購入番号が重複するバグを修正。

## v5.4.1 - 2018-01-19
### Changed
- 注文取引開始時にstaffアプリケーションに関しては特別に許可証を非必須化(一時的な対応)

## v5.4.0 - 2018-01-19
### Changed
- 注文取引開始時のWAITER許可証を必須化。

## v5.3.0 - 2018-01-17
### Changed
- 予約の属性に在庫情報リストを追加。

## v5.2.1 - 2018-01-15
### Changed
- GMOオーソリタイムアウトハンドリングを調整。

## v5.2.0 - 2018-01-11
### Changed
- 管理者トークンエンドポイントにクライアントによるベーシック認証を追加。
- イベント検索のパフォーマンス向上。

## v5.1.0 - 2018-01-10
### Added
- 管理者トークン発行エンドポイントを追加。
- 管理者エンドポイントを追加。

## v5.0.0 - 2018-01-10
### Added
- クライアント認証の仕組みを実装。
- 許可スコープチェックの仕組みを実装。
- 取引ルーターを追加。
- 座席仮予約エンドポイントを追加。
- 座席仮予約解除エンドポイントを追加。
- 座席本予約エンドポイントを追加。
- 座席本予約取消エンドポイントを追加。
- IDでパフォーマンス検索のエンドポイントを追加。
- 識別子で企業組織検索のエンドポイントを追加。
- 注文照会エンドポイントを追加。
- 入場(取消)エンドポイントを追加。
- 予約検索エンドポイントを追加。

### Changed
- パフォーマンス検索のレスポンスを多言語化。
- HTTPステータスコードの振り分けをルーターに記述するように統一。
- ttts-domain@12.0.0に対応。
- APIの認証情報をCognitoから取得するように変更。
- パフォーマンス検索結果の券種情報を強化。在庫状況情報も強化。
- multi issuer対応。
- 取引にAPIクライアント情報を結合。
- 返品確定サービスを購入者区分に関わらず汎用化。
- 注文取引確定のレスポンスに属性追加。

### Removed
- configパッケージを削除。環境依存変数を全てprocess.envへ移行。
- 不要なルーターを削除。

### Security
- update package [tslint@5.8.0](https://www.npmjs.com/package/tslint)
- update package [typescript@2.6.2](https://www.npmjs.com/package/typescript)

## v4.0.0 - 2017-05-05
### Added
- chevreを継承してリリース。
